name: Deploy Next.js Frontend to Oracle Cloud (Runner Build)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    # ----------------------------------------------------------------------
    # 1. GitHub Runnerì—ì„œ Next.js í™˜ê²½ ì„¤ì • ë° ë¹Œë“œ (RAM 7GB ì‚¬ìš©)
    # ----------------------------------------------------------------------
    - name: Setup Node.js Environment
      uses: actions/setup-node@v4
      with:
        node-version: '20' # ğŸŒŸ ì‚¬ìš©í•˜ì‹œëŠ” Node.js ë²„ì „ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”

    - name: Install Dependencies & Build (on Runner)
      run: |
        echo "=== Installing Dependencies on Runner ==="
        npm install
        
        echo "=== Building Next.js on Runner ==="
        npm run build 
        
    - name: Create .env.local for Remote Server
      # ì„œë²„ì—ì„œ í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      run: |
        cat > .env.local << 'ENVEOF'
        NEXT_PUBLIC_API_URL=http://${{ secrets.SERVER_IP }}:8000
        ENVEOF

    # ----------------------------------------------------------------------
    # 2. ì„œë²„ í™˜ê²½ ì •ë¦¬ ë° íŒŒì¼ ì „ì†¡ (SCP ì‚¬ìš©)
    # ----------------------------------------------------------------------
    - name: SSH - Clean Up Remote Environment & Stop Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e
          DEPLOY_DIR=~/korea-sky-planner-frontend
          
          echo "=== Stopping Existing Next.js Server ==="
          screen -S nextjs -X quit || true
          
          echo "=== Cleaning Old Build Artifacts ==="
          # ì´ì „ ë¹Œë“œ íŒŒì¼(.next) ë° ì‹¤í–‰ ì˜ì¡´ì„± í´ë” ì‚­ì œ
          rm -rf $DEPLOY_DIR/.next $DEPLOY_DIR/node_modules
          
    - name: SCP - Transfer Build Artifacts to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        # .next, public, package.json, .env.local ë“± ì‹¤í–‰ì— í•„ìš”í•œ íŒŒì¼ë§Œ ì „ì†¡
        source: ".next,public,package.json,package-lock.json,.env.local" 
        target: "~/korea-sky-planner-frontend" # ì„œë²„ì˜ í”„ë¡œì íŠ¸ ê²½ë¡œ

    # ----------------------------------------------------------------------
    # 3. ì„œë²„ì—ì„œ ì¬ì‹¤í–‰ (Production Install & Start)
    # ----------------------------------------------------------------------
    - name: SSH - Start Next.js Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e
          DEPLOY_DIR=~/korea-sky-planner-frontend
          
          cd $DEPLOY_DIR
          
          echo "=== Installing Production Dependencies (Small) ==="
          # ì‹¤í–‰ì— í•„ìš”í•œ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜ (--omit=dev). ë¹Œë“œë³´ë‹¤ í›¨ì”¬ ë¹ ë¦„.
          npm install --omit=dev 

          echo "=== Starting Next.js Server ==="
          screen -dmS nextjs bash -c 'cd $DEPLOY_DIR && npm start > nextjs.log 2>&1'
          
          sleep 5
          
          # ì„œë²„ í™•ì¸ ë° ë¡œê·¸ ì¶œë ¥
          if screen -list | grep -q "nextjs"; then
            echo "Next.js server is running"
          else
            echo "Failed to start Next.js server"
            cat nextjs.log
            exit 1
          fi
          
          echo "=== Frontend Deployment Completed ==="